# SBB FDK MCP Server

<div align="center">

Model Context Protocol (MCP) Server f√ºr Fachdatenkatalog (FDK)

[![Python](https://img.shields.io/badge/python-3.13+-blue.svg)](https://www.python.org/downloads/)
[![MCP](https://img.shields.io/badge/MCP-1.18+-green.svg)](https://modelcontextprotocol.io/)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)

</div>

---

## üìã √úbersicht

Dieser MCP-Server erm√∂glicht es Claude (Desktop & Code), auf den SBB Fachdatenkatalog zuzugreifen und diesen zu durchsuchen. Der Server implementiert intelligentes Caching, umfassende Suchfunktionen und bietet sowohl JSON- als auch Markdown-Ausgaben.

### ‚ú® Features

- üóÑÔ∏è **Smart Caching**: Lokaler JSON-Cache mit 24h Auto-Refresh
- üîç **9 Leistungsstarke Tools**: Umfassende Such- und Abfragefunktionen inkl. Advanced Search
- üìä **Dual-Format**: JSON f√ºr APIs, Markdown f√ºr Menschen
- üèóÔ∏è **Clean Architecture**: Modulares Design mit SOLID-Prinzipien
- ‚ö° **Python 3.13+**: Moderne Type Hints und Union-Operatoren
- üîÑ **Retry-Logik**: Robuste API-Kommunikation mit exponentieller Backoff
- üåê **Multi-Language**: Unterst√ºtzung f√ºr DE, FR, IT, EN
- üìà **Real-time Progress**: MCP-basierte Progress Notifications f√ºr Downloads
- üìù **Comprehensive Logging**: Vollst√§ndiges Logging √ºber MCP Context
- üöÄ **Parallel Downloads**: Bis zu 20x schnellerer Download mit Concurrency
- üéØ **Type-Safe**: TypedDict f√ºr vollst√§ndige Type Safety ohne Runtime Overhead

---

## üì¶ Installation

### Voraussetzungen

- **Python 3.13+** ([Download](https://www.python.org/downloads/))
- **uv** Package Manager ([Installation](https://github.com/astral-sh/uv))

### Server Installation

#### MCP Server Konfigurieren

##### Mit UV

```json
{
  "mcpServers": {
    "sbb-fdk": {
      "command": "uv",
      "args": [
        "--directory",
        "C:\\workspace\\elyo\\ai\\projects\\fdk-sbb\\src",
        "run",
        "sbb_fdk_mcp"
      ]
    }
  }
}
```

##### Mit UVX

```json
{
  "mcpServers": {
    "sbb-fdk": {
      "command": "uvx",
      "args": [
        "--directory",
        "C:\\workspace\\elyo\\ai\\projects\\fdk-sbb\\src",
        "sbb_fdk_mcp"
      ]
    }
  }
}
```

```bash
# Repository klonen oder entpacken
cd C:\workspace\elyo\ai\projects\fdk-sbb

# Dependencies installieren mit uv
uv sync

# Server testen
uv run python test_server.py
```

---

## üîå Integration mit Claude

### Option 1: Claude Desktop (macOS & Windows)

#### Schritt 1: Konfigurationsdatei √∂ffnen

**macOS:**

```bash
code ~/Library/Application\ Support/Claude/claude_desktop_config.json
```

**Windows:**

```powershell
code $env:APPDATA\Claude\claude_desktop_config.json
```

#### Schritt 2: Server konfigurieren

F√ºgen Sie folgende Konfiguration hinzu:

```json
{
  "mcpServers": {
    "sbb-fdk": {
      "command": "uv",
      "args": [
      "--directory",
      "C:\\workspace\\elyo\\ai\\projects\\fdk-sbb\\src"
        "run",
        "sbb_fdk_mcp"
      ]
    }
  }
}
```

**Hinweis:** Passen Sie den `cwd`-Pfad an Ihre Installation an!

#### Schritt 3: Claude Desktop neu starten

Starten Sie Claude Desktop neu, damit die √Ñnderungen wirksam werden.

---

### Option 2: Claude Code (VS Code Extension)

#### Schritt 1: Konfigurationsdatei erstellen/bearbeiten

**macOS/Linux:**

```bash
code ~/.claude/config.json
```

**Windows:**

```powershell
code $env:USERPROFILE\.claude\config.json
```

#### Schritt 2: Server konfigurieren

```json
{
  "mcpServers": {
    "sbb-fdk": {
      "command": "uv",
      "args": [
        "--directory",
        "C:\\workspace\\elyo\\ai\\projects\\fdk-sbb\\src",
        "run",
        "sbb_fdk_mcp"
      ]
    },
    // Alternative mit uvx
    "sbb-fdk": {
      "command": "uvx",
      "args": [
        "--directory",
        "C:\\workspace\\elyo\\ai\\projects\\fdk-sbb\\src",
        "sbb_fdk_mcp"
      ]
    }
  }
}
```

#### Schritt 3: VS Code neu laden

F√ºhren Sie in VS Code den Befehl aus:

Developer: Reload Window

oder dr√ºcken Sie `Ctrl+R` (Windows/Linux) / `Cmd+R` (macOS)

---

## üõ†Ô∏è Verf√ºgbare Tools

### 1. `sbb_fdk_list_objects`

Liste und durchsuche FDK-Objekte mit Filtern und Pagination.

**Parameter:**

- `domain` (optional): Filter nach Domain (z.B. "Br√ºcken", "Energie")
- `search` (optional): Suchbegriff f√ºr Objektnamen
- `limit` (optional): Max. Anzahl Ergebnisse (1-100, Standard: 20)
- `offset` (optional): √úberspringe Ergebnisse f√ºr Pagination (Standard: 0)
- `detail` (optional): "concise" oder "detailed" (Standard: concise)
- `response_format` (optional): "markdown" oder "json" (Standard: markdown)

**Beispiele:**

Zeige mir alle Br√ºcken-Objekte
Liste die ersten 50 Energie-Objekte
Suche nach "St√ºtze" im FDK-Katalog

---

### 2. `sbb_fdk_get_object`

Erhalte vollst√§ndige Details zu einem spezifischen FDK-Objekt.

**Parameter:**

- `object_id` (erforderlich): Objekt-ID (z.B. "OBJ_BR_1")
- `language` (optional): Sprachcode (de/fr/it/en, Standard: de)
- `response_format` (optional): "markdown" oder "json" (Standard: markdown)

**Beispiele:**

Zeige Details f√ºr Objekt OBJ_BR_1
Gib mir OBJ_EN_1 auf Franz√∂sisch

---

### 3. `sbb_fdk_search_properties`

Durchsuche Properties √ºber den gesamten Katalog.

**Parameter:**

- `query` (erforderlich): Suchbegriff f√ºr Property-Namen
- `limit` (optional): Max. Anzahl Ergebnisse (1-100, Standard: 20)
- `response_format` (optional): "markdown" oder "json" (Standard: markdown)

**Beispiele:**

Finde alle Properties mit "Breite"
Suche nach Material-Properties

---

### 4. `sbb_fdk_advanced_search` ‚ú® NEU

Erweiterte Suche √ºber **beliebige JSON-Felder** mit flexiblen Match-Modi.

**Parameter:**

- `search_fields` (optional): Liste von Feldern zum Durchsuchen (Standard: ["all"])
  - Optionen: "all", "propertySets", "properties", "ifcClassAssignments", "ebkpConcepts", "aksCode", "componentRelationships", "assemblyRelationships", "domainModel", "nameObjectGroup", "nameSubgroup", "description", "name"
- `query` (erforderlich): Suchbegriff
- `domain_filter` (optional): Nur in bestimmter Domain suchen
- `match_mode` (optional): Art des Matchings (Standard: "contains")
  - "contains": Enth√§lt den Suchbegriff
  - "equals": Exakte √úbereinstimmung
  - "starts_with": Beginnt mit
  - "ends_with": Endet mit
- `case_sensitive` (optional): Gro√ü-/Kleinschreibung beachten (Standard: false)
- `limit` (optional): Max. Anzahl Ergebnisse (1-200, Standard: 50)
- `response_format` (optional): "markdown" oder "json" (Standard: markdown)

**Features:**

- üîç **Rekursive Suche**: Durchsucht verschachtelte JSON-Strukturen
- üöÄ **Auto-Download**: L√§dt Detail-Objekte transparent nach wenn ben√∂tigt
- üéØ **Flexible Matching**: Verschiedene Match-Modi f√ºr pr√§zise Suchen
- ‚ö° **Performant**: Sucht gesamten Katalog in Sekunden

**Beispiele:**

```
Finde PropertySet "Pset_WallCommon"
  ‚Üí search_fields=["propertySets"], query="Pset_WallCommon"

Suche nach IFC-Klasse "IfcWall" in Hochbau
  ‚Üí search_fields=["ifcClassAssignments"], query="IfcWall", domain_filter="Hochbau"

Finde alle eBKP-Codes mit "C3"
  ‚Üí search_fields=["ebkpConcepts"], query="C3"

Suche √ºberall nach "St√ºtze"
  ‚Üí search_fields=["all"], query="St√ºtze"

Exakte Suche nach PropertySet
  ‚Üí search_fields=["propertySets"], query="Pset_WallCommon", match_mode="equals"

PropertySets die mit "Pset_" beginnen
  ‚Üí search_fields=["propertySets"], query="Pset_", match_mode="starts_with"
```

**WICHTIG f√ºr AI:**

- ‚ùå **NICHT** eigenen Python-Code schreiben zum Suchen/Filtern!
- ‚úÖ **Nutze dieses Tool** - es ist 100x schneller und effizienter!
- Das Tool l√§dt automatisch ben√∂tigte Daten herunter

---

### 5. `sbb_fdk_list_domains`

Liste alle Domains mit Objekt-Anzahl.

**Beispiele:**

Zeige mir eine √úbersicht aller FDK-Domains
Welche Domains gibt es im Katalog?

---

### 6. `sbb_fdk_refresh_cache`

Erzwinge Cache-Aktualisierung von der API.

**Beispiele:**

Aktualisiere den FDK-Cache
Lade die neuesten Daten vom FDK

---

### 7. `sbb_fdk_get_cache_stats`

Zeige Cache-Statistiken und Status.

**Beispiele:**

Wie ist der Cache-Status?
Wann wurde der Cache zuletzt aktualisiert?

---

### 8. `sbb_fdk_download_all_objects` ‚ú® NEU

Lade alle Detail-Objekte vom API herunter (mit paralleler Verarbeitung).

**Parameter:**

- `language` (optional): Sprachcode (de/fr/it/en, Standard: de)
- `domain_filter` (optional): Nur Objekte einer Domain (z.B. "Hochbau", "Br√ºcken")
- `max_concurrent` (optional): Anzahl paralleler Downloads (1-20, Standard: 10)
- `response_format` (optional): "markdown" oder "json" (Standard: markdown)

**Features:**

- ‚ö° **Parallel Processing**: 10-20 gleichzeitige Downloads
- üìà **Real-time Progress**: Live-Updates via MCP Notifications
- üéØ **Domain Filtering**: Nur gew√ºnschte Domains laden
- üîÑ **Retry Logic**: 3x Retry mit exponentieller Backoff
- ‚è±Ô∏è **Performance**: ~2-3 Minuten f√ºr alle 1687 Objekte

**Beispiele:**

```
Lade alle FDK-Objekte herunter
Lade nur Hochbau-Objekte mit 15 parallelen Downloads
Downloade alle Br√ºcken-Objekte auf Franz√∂sisch
```

---

### 9. `sbb_fdk_update_cache` ‚ú® NEU

Aktualisiere fehlende oder veraltete Objekte im Cache (intelligent & parallel).

**Parameter:**

- `language` (optional): Sprachcode (de/fr/it/en, Standard: de)
- `domain_filter` (optional): Nur Objekte einer Domain
- `force_refresh` (optional): Alle Objekte neu laden (Standard: false)
- `max_concurrent` (optional): Anzahl paralleler Downloads (1-20, Standard: 10)
- `response_format` (optional): "markdown" oder "json" (Standard: markdown)

**Features:**

- üß† **Smart Update**: L√§dt nur fehlende/unvollst√§ndige Objekte
- ‚ö° **Viel schneller** als Full-Download wenn Cache existiert
- üìà **Progress Tracking**: Live-Updates w√§hrend des Updates
- üîÑ **Safe to run**: Kann regelm√§√üig ausgef√ºhrt werden

**Beispiele:**

```
Aktualisiere den Cache mit fehlenden Objekten
Force-refresh alle Energie-Objekte
Update nur Hochbau-Objekte
```

---

## üí° Verwendungsbeispiele

### In Claude Desktop / Claude Code

```
üë§ User: Zeige mir alle Br√ºcken-Objekte im FDK-Katalog

ü§ñ Claude: Ich verwende das Tool sbb_fdk_list_objects mit domain="Br√ºcken"...
[Ergebnisse werden angezeigt]

üë§ User: Gib mir Details zu OBJ_BR_1

ü§ñ Claude: Ich hole die Details mit sbb_fdk_get_object...
[Details werden angezeigt]

üë§ User: Welche Properties gibt es zum Thema "Breite"?

ü§ñ Claude: Ich suche mit sbb_fdk_search_properties...
[Properties werden angezeigt]

üë§ User: Lade alle Hochbau-Objekte herunter

ü§ñ Claude: Ich starte den Download mit sbb_fdk_download_all_objects...
üìà Progress: 10/54 (18.5%) | 3.1 obj/sec | ETA: 0m 14s | Domain: Hochbau
üìà Progress: 20/54 (37.0%) | 3.2 obj/sec | ETA: 0m 11s | Domain: Hochbau
...
‚úÖ Download completed: 54/54 successful in 0m 17s
```

---

## üöÄ Performance & Features

### Download Performance

| Scenario                | Objects | Time     | Speed        | Mode            |
| ----------------------- | ------- | -------- | ------------ | --------------- |
| Full Download           | 1687    | ~2-3 min | ~10-12 obj/s | Parallel (10)   |
| Single Domain (Br√ºcken) | 54      | ~17s     | ~3.1 obj/s   | Parallel (10)   |
| Sequential (Old)        | 1687    | ~10 min  | ~2.8 obj/s   | Single-threaded |
| Max Parallel (20)       | 1687    | ~90s     | ~18 obj/s    | Parallel (20)   |

### Real-time Progress Tracking

Alle Download-Tools senden **Echtzeit-Updates** via MCP Notifications:

```
üìà 10/1687 (0.6%) | 3.2 obj/sec | ETA: 8m 42s | Domain: Br√ºcken
üìà 20/1687 (1.2%) | 3.1 obj/sec | ETA: 8m 55s | Domain: Energie
üìà 30/1687 (1.8%) | 3.0 obj/sec | ETA: 9m 12s | Domain: Hochbau
...
```

### Comprehensive Logging

Der Server logged alle wichtigen Events via MCP Context:

- **DEBUG**: Cache-Hits, API-Request-Details
- **INFO**: Tool-Starts, erfolgreiche Downloads, Cache-Updates
- **WARNING**: API-Retries, Cache-Miss, Timeouts
- **ERROR**: API-Fehler, Validierungsfehler, Download-Failures

Logs sind in Claude Desktop/Code sichtbar und k√∂nnen f√ºr Debugging verwendet werden.

---

## üèóÔ∏è Architektur

```
fdk-sbb/
‚îú‚îÄ‚îÄ src/sbb_fdk_mcp/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py       # Package-Initialisierung
‚îÇ   ‚îú‚îÄ‚îÄ __main__.py       # Entry Point
‚îÇ   ‚îú‚îÄ‚îÄ server.py         # MCP Tools (8 Tools mit Context & Logging)
‚îÇ   ‚îú‚îÄ‚îÄ service.py        # Business Logic (mit Progress Tracking)
‚îÇ   ‚îú‚îÄ‚îÄ api_client.py     # HTTP Client mit Retry & Logging
‚îÇ   ‚îú‚îÄ‚îÄ cache.py          # JSON File Cache
‚îÇ   ‚îú‚îÄ‚îÄ utils.py          # Formatierung & ProgressTracker
‚îÇ   ‚îú‚îÄ‚îÄ models.py         # Pydantic Input Models
‚îÇ   ‚îú‚îÄ‚îÄ types.py          # TypedDict Definitions (NEW)
‚îÇ   ‚îî‚îÄ‚îÄ constants.py      # Konfiguration
‚îú‚îÄ‚îÄ cache/                # Auto-generiertes Cache-Verzeichnis
‚îÇ   ‚îú‚îÄ‚îÄ objects/          # Gecachte FDK-Objekte als JSON
‚îÇ   ‚îî‚îÄ‚îÄ metadata.json     # Cache-Metadaten (mit Release Info)
‚îú‚îÄ‚îÄ tests/                # Test-Verzeichnis
‚îú‚îÄ‚îÄ prompts.md            # Prompt-Vorschl√§ge (Dokumentation)
‚îú‚îÄ‚îÄ pyproject.toml        # uv Projektkonfiguration
‚îú‚îÄ‚îÄ pyrightconfig.json    # Pyright Type Checker Konfiguration
‚îú‚îÄ‚îÄ ruff.toml             # Ruff Linter & Formatter Konfiguration
‚îú‚îÄ‚îÄ .editorconfig         # Editor-Konfiguration
‚îú‚îÄ‚îÄ Makefile              # Entwickler-Befehle
‚îú‚îÄ‚îÄ README.md             # Diese Datei
‚îú‚îÄ‚îÄ .gitignore            # Git Ignore-Regeln
‚îî‚îÄ‚îÄ test_server.py        # Schneller Verifikationstest
```

### Komponenten-Beschreibung

- **server.py**: Implementiert alle 8 MCP-Tools mit Context-Injection & Logging
- **service.py**: Business Logic mit MCP Context f√ºr Progress & Logging
- **api_client.py**: HTTP-Client mit Retry-Logik & optionalem Context-Logging
- **cache.py**: JSON-Cache mit Release-Info & Metadaten
- **utils.py**: Formatierung, ProgressTracker f√ºr Download-Statistiken
- **models.py**: Pydantic-Modelle f√ºr strikte Input-Validierung
- **types.py**: TypedDict Definitionen f√ºr API-Responses & Cache-Strukturen
- **constants.py**: Zentrale Konfigurationskonstanten

---

## üß™ Entwicklung & Testing

### Quick Start

```bash
# Schnelltest
uv run python test_server.py

# Alle Checks ausf√ºhren
make check
```

### Development Commands

Das Projekt verwendet **Makefile** f√ºr einfache Entwicklung:

```bash
# Dependencies installieren
make install

# Code Linting (ruff)
make lint

# Code Formatierung (ruff)
make format

# Type Checking (pyright)
make typecheck

# Alle Checks (lint + typecheck)
make check

# Tests ausf√ºhren
make test

# Server starten
make run

# Cache aufr√§umen
make clean
```

### Manuelle Commands

```bash
# Ruff Linting
uv run ruff check src/
uv run ruff check --fix src/    # Auto-fix

# Ruff Formatierung
uv run ruff format src/
uv run ruff format --check src/ # Nur Check

# Pyright Type Checking
uv run pyright src/

# Tests
uv run pytest
```

### Code-Qualit√§tsmetriken

‚úÖ **Vollst√§ndige Type Safety** mit TypedDict (ohne Runtime Overhead)
‚úÖ **MCP Context Integration** f√ºr Logging & Progress
‚úÖ **Parallel Processing** mit asyncio.Semaphore
‚úÖ **Max. 120 Zeichen pro Zeile**
‚úÖ **Vollst√§ndige Type Hints** mit Python 3.13 Syntax
‚úÖ **Clean Code Prinzipien** durchg√§ngig angewendet
‚úÖ **Pyright Strict Mode** - 0 Fehler, 0 Warnings
‚úÖ **Ruff Linting** - Alle Checks bestanden

---

## üîß Troubleshooting

### Problem: Server startet nicht

**L√∂sung:**

```bash
# Pr√ºfen Sie Python-Version
python --version  # Sollte 3.13+ sein

# uv neu installieren
pip install --upgrade uv

# Dependencies neu installieren
cd fdk-sbb
uv sync --force
```

### Problem: Cache wird nicht erstellt

**L√∂sung:**

```bash
# Verzeichnisse manuell erstellen
mkdir -p cache/objects

# Berechtigungen pr√ºfen (Linux/macOS)
chmod -R 755 cache
```

### Problem: API-Verbindungsfehler

**L√∂sung:**

- Pr√ºfen Sie Ihre Internetverbindung
- Die API unter `https://bim-fdk-api.app.sbb.ch` sollte erreichbar sein
- Der Server nutzt automatisch den Cache bei API-Ausf√§llen

### Problem: Claude erkennt Server nicht

**L√∂sung:**

1. Pr√ºfen Sie den `cwd`-Pfad in der Konfiguration
2. Stellen Sie sicher, dass `uv` im PATH ist
3. Starten Sie Claude neu
4. √úberpr√ºfen Sie die Logs in Claude

**Logs anzeigen:**

- **Claude Desktop**: `Help ‚Üí View Logs`
- **Claude Code**: VS Code Output Panel ‚Üí "Claude Code"

---

## üìä API Referenz

### SBB FDK API

**Base URL:** `https://bim-fdk-api.app.sbb.ch`

**Endpoints:**

- `GET /objects?language={lang}` - Liste aller Objekte
- `GET /objects/{id}?language={lang}` - Objekt-Details

**Unterst√ºtzte Sprachen:** `de`, `fr`, `it`, `en`

---

## ü§ù Beitragen

Beitr√§ge sind willkommen! Bitte beachten Sie:

1. Code-Qualit√§tsstandards einhalten
2. Tests f√ºr neue Features schreiben
3. Dokumentation aktualisieren
4. Pull Requests mit klarer Beschreibung erstellen

---

## üìÑ Lizenz

MIT License - siehe [LICENSE](LICENSE) Datei f√ºr Details.

---

## üë®‚Äçüíª Autor

Erstellt mit Claude Code unter Verwendung von:

- **Python 3.13**
- **MCP SDK 1.18+**
- **FastMCP Framework**
- **Pydantic 2.12+**
- **HTTPX 0.28+**

---

## üîó Weiterf√ºhrende Links

- [Model Context Protocol Dokumentation](https://modelcontextprotocol.io/)
- [Claude Desktop](https://claude.ai/desktop)
- [Claude Code Extension](https://marketplace.visualstudio.com/items?itemName=Anthropic.claude-code)
- [uv Package Manager](https://github.com/astral-sh/uv)
- [SBB FDK API](https://bim-fdk-api.app.sbb.ch/)

---

<div align="center">

**Gebaut mit ‚ù§Ô∏è f√ºr die SBB Community**

</div>
